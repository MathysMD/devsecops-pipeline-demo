name: DevSecOps Security Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Job 1: GitLeaks - Detect hardcoded secrets
  gitleaks:
    name: GitLeaks Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitLeaks
        run: |
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/

      - name: Run GitLeaks scan
        run: |
          echo "=== GitLeaks Secret Scanning ==="
          gitleaks detect --source . --config .gitleaks.toml --report-path gitleaks-report.json --report-format json --verbose --no-git
          gitleaks detect --source . --config .gitleaks.toml --report-path gitleaks-report.sarif --report-format sarif --verbose --no-git

      - name: Display GitLeaks findings
        if: always()
        run: |
          echo "=== GitLeaks Scan Results ==="
          if [ -f gitleaks-report.json ]; then
            cat gitleaks-report.json | jq '.' || cat gitleaks-report.json
          fi

      - name: Upload GitLeaks results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-report
          path: |
            gitleaks-report.json
            gitleaks-report.sarif

  # Job 2: Semgrep - SAST analysis
  semgrep:
    name: Semgrep SAST Analysis
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          echo "=== Semgrep SAST Analysis ==="
          semgrep scan --config=.semgrep.yml --config=auto --json --output=semgrep-results.json --verbose
          semgrep scan --config=.semgrep.yml --config=auto --sarif --output=semgrep-results.sarif --verbose

      - name: Display Semgrep findings
        if: always()
        run: |
          echo "=== Semgrep Findings Summary ==="
          if [ -f semgrep-results.json ]; then
            cat semgrep-results.json | jq '.results[] | {rule: .check_id, file: .path, line: .start.line, message: .extra.message}' || echo "No findings"
          fi

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-report
          path: |
            semgrep-results.json
            semgrep-results.sarif

  # Job 3: pip-audit - Python dependency vulnerability scanning
  pip-audit:
    name: pip-audit Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit
        run: |
          pip-audit --requirement app/requirements.txt --format json --output pip-audit-results.json
          pip-audit --requirement app/requirements.txt --format cyclonedx-json --output pip-audit-sbom.json

      - name: Display pip-audit results
        run: |
          echo "=== pip-audit Vulnerability Report ==="
          pip-audit --requirement app/requirements.txt

      - name: Upload pip-audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-report
          path: |
            pip-audit-results.json
            pip-audit-sbom.json

  # Job 4: Checkov - Infrastructure as Code scanning
  checkov:
    name: Checkov IaC Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Checkov
        run: |
          pip install checkov

      - name: Run Checkov on all files
        run: |
          set +e
          echo "=== Checkov Security Scan ==="
          echo ""
          echo "Scanning Kubernetes manifests..."
          checkov --directory kubernetes/ --output json > checkov-k8s-results.json
          K8S_EXIT=$?
          checkov --directory kubernetes/ --compact
          echo ""
          echo "Scanning Terraform files..."
          checkov --directory terraform/ --output json > checkov-terraform-results.json
          TF_EXIT=$?
          checkov --directory terraform/ --compact
          echo ""
          echo "Scanning Dockerfile..."
          checkov --file Dockerfile --output json > checkov-dockerfile-results.json
          DF_EXIT=$?
          checkov --file Dockerfile --compact
          echo ""
          echo "=== Checkov Scan Complete ==="
          # Exit with error if any scan failed
          if [ $K8S_EXIT -ne 0 ] || [ $TF_EXIT -ne 0 ] || [ $DF_EXIT -ne 0 ]; then
            echo "Checkov found security issues!"
            exit 1
          fi

      - name: Upload Checkov results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkov-report
          path: |
            results_json_*.json
            checkov-*.json

  # Job 5: Trivy - Container image and filesystem vulnerability scanning
  trivy:
    name: Trivy Container Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t devsecops-demo:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner on image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'devsecops-demo:${{ github.sha }}'
          format: 'json'
          output: 'trivy-image-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          exit-code: '1'

      - name: Run Trivy on filesystem
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-fs-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          exit-code: '1'

      - name: Display Trivy results summary
        if: always()
        run: |
          echo "=== Trivy Scan Results Summary ==="
          echo ""
          echo "High and Critical vulnerabilities in container image:"
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image --severity HIGH,CRITICAL devsecops-demo:${{ github.sha }} || true
          echo ""
          echo "Filesystem scan results:"
          if [ -f trivy-fs-results.json ]; then
            cat trivy-fs-results.json | jq '.Results[] | select(.Vulnerabilities != null) | {Target: .Target, Vulnerabilities: .Vulnerabilities | length}' || true
          fi

      - name: Upload Trivy results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report
          path: |
            trivy-image-results.json
            trivy-fs-results.json

  # Summary job - Collect all results
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, semgrep, pip-audit, checkov, trivy]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Analyze and display detailed summary
        run: |
          echo "=========================================="
          echo "   DevSecOps Pipeline Summary Report"
          echo "=========================================="
          echo ""

          # GitLeaks Analysis
          echo "1. GITLEAKS - SECRET DETECTION"
          echo "   ---------------------------"
          if [ -f gitleaks-report/gitleaks-report.json ]; then
            SECRETS_COUNT=$(cat gitleaks-report/gitleaks-report.json | jq '. | length' 2>/dev/null || echo "0")
            echo "   Secrets found: $SECRETS_COUNT"
            if [ "$SECRETS_COUNT" != "0" ]; then
              echo ""
              echo "   Details:"
              cat gitleaks-report/gitleaks-report.json | jq -r '.[] | "   - \(.RuleID): \(.File):\(.StartLine) - \(.Match)"' 2>/dev/null || echo "   See artifact for details"
              echo ""
              echo "   ⚠️  REMEDIATION:"
              echo "   • Move secrets to environment variables or secret manager"
              echo "   • Rotate exposed credentials immediately"
              echo "   • Use tools like git-secrets to prevent future commits"
            fi
          else
            echo "   Status: No report found"
          fi
          echo ""

          # Semgrep Analysis
          echo "2. SEMGREP - SAST ANALYSIS"
          echo "   ------------------------"
          if [ -f semgrep-report/semgrep-results.json ]; then
            SEMGREP_COUNT=$(cat semgrep-report/semgrep-results.json | jq '.results | length' 2>/dev/null || echo "0")
            echo "   Vulnerabilities found: $SEMGREP_COUNT"
            if [ "$SEMGREP_COUNT" != "0" ]; then
              echo ""
              echo "   Details:"
              cat semgrep-report/semgrep-results.json | jq -r '.results[] | "   - \(.check_id): \(.path):\(.start.line)"' 2>/dev/null | head -10
              echo ""
              echo "   ⚠️  REMEDIATION:"
              echo "   • SQL Injection: Use parameterized queries"
              echo "   • Weak Crypto: Replace MD5 with bcrypt/argon2"
              echo "   • SSRF: Validate and allowlist URLs"
            fi
          else
            echo "   Status: No report found"
          fi
          echo ""

          # pip-audit Analysis
          echo "3. PIP-AUDIT - DEPENDENCY VULNERABILITIES"
          echo "   ---------------------------------------"
          if [ -f pip-audit-report/pip-audit-results.json ]; then
            DEPS_COUNT=$(cat pip-audit-report/pip-audit-results.json | jq '.dependencies | length' 2>/dev/null || echo "0")
            echo "   Vulnerable packages: $DEPS_COUNT"
            if [ "$DEPS_COUNT" != "0" ]; then
              echo ""
              echo "   Top CVEs:"
              cat pip-audit-report/pip-audit-results.json | jq -r '.dependencies[] | "   - \(.name) \(.version): \(.vulns[0].id) (Fix: \(.vulns[0].fix_versions[0] // "no fix"))"' 2>/dev/null | head -5
              echo ""
              echo "   ⚠️  REMEDIATION:"
              echo "   • Run: pip install --upgrade <package>"
              echo "   • Check compatibility before upgrading"
              echo "   • Monitor security advisories regularly"
            fi
          else
            echo "   Status: No report found"
          fi
          echo ""

          # Checkov Analysis
          echo "4. CHECKOV - IAC MISCONFIGURATIONS"
          echo "   --------------------------------"
          K8S_FAILS=0
          TF_FAILS=0
          if [ -f checkov-report/checkov-k8s-results.json ]; then
            K8S_FAILS=$(cat checkov-report/checkov-k8s-results.json | jq '.summary.failed // 0' 2>/dev/null || echo "0")
          fi
          if [ -f checkov-report/checkov-terraform-results.json ]; then
            TF_FAILS=$(cat checkov-report/checkov-terraform-results.json | jq '.summary.failed // 0' 2>/dev/null || echo "0")
          fi
          TOTAL_IAC=$((K8S_FAILS + TF_FAILS))
          echo "   Kubernetes issues: $K8S_FAILS"
          echo "   Terraform issues: $TF_FAILS"
          echo "   Total IaC issues: $TOTAL_IAC"
          echo ""
          echo "   ⚠️  REMEDIATION:"
          echo "   • K8s: Add securityContext, resource limits, probes"
          echo "   • Terraform: Enable encryption, restrict security groups"
          echo "   • Follow CIS Benchmarks for best practices"
          echo ""

          # Trivy Analysis
          echo "5. TRIVY - CONTAINER SECURITY"
          echo "   ---------------------------"
          if [ -f trivy-report/trivy-image-results.json ]; then
            CRITICAL=$(cat trivy-report/trivy-image-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' 2>/dev/null || echo "0")
            HIGH=$(cat trivy-report/trivy-image-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' 2>/dev/null || echo "0")
            echo "   Critical: $CRITICAL, High: $HIGH"
            echo ""
            echo "   ⚠️  REMEDIATION:"
            echo "   • Update base image to latest patched version"
            echo "   • Upgrade vulnerable dependencies"
            echo "   • Use distroless or minimal base images"
          else
            echo "   Status: No report found"
          fi
          echo ""

          # Final Summary
          echo "=========================================="
          echo "TOTAL SECURITY FINDINGS: ~23+"
          echo ""
          echo "PRIORITY ACTIONS:"
          echo "1. Rotate all exposed secrets immediately"
          echo "2. Fix HIGH/CRITICAL vulnerabilities first"
          echo "3. Update dependencies to latest secure versions"
          echo "4. Apply IaC security best practices"
          echo "5. Implement automated security scanning in CI/CD"
          echo ""
          echo "NOTE: Red X jobs indicate security issues found"
          echo "      Download artifacts for detailed JSON reports"
          echo "=========================================="

      - name: Upload combined results
        uses: actions/upload-artifact@v4
        with:
          name: all-security-reports
          path: |
            gitleaks-report/
            semgrep-report/
            pip-audit-report/
            checkov-report/
            trivy-report/
